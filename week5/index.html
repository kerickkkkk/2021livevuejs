<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>2021-Live-Vue-JS-week5</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-+0n0xVW2eSR5OomGNYDnhzAbDsOXxcvSN1TPprVMTNDbiYZCxYbOOl7+AMvyTG2x"
      crossorigin="anonymous"
    />
    <style>
      .bg-cover{
        background-position: center center;
        background-size: cover;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <!-- 產品區塊 -->
      <div class="container">
        <h3>產品區塊</h3>
        <div class="row">
          <div class="col-md-4 mb-3" v-for="item in products" :key="item.id">
            <div class="card h-100">
              <img :src="item.imageUrl" class="card-img-top" alt="圖片" />
              <div class="card-body">
                <div class="d-flex justify-content-between">
                  <h5 class="card-title">{{item.title}}</h5>
                  <div>
                    <div class="badge rounded-pill bg-secondary h5">
                      {{item.category}}
                    </div>
                  </div>
                </div>
                <div class="d-flex justify-content-between">
                  <template v-if="item.origin_price === item.price">
                    <span class="h5 ms-auto">${{item.origin_price}}</span>
                  </template>
                  <template v-else>
                    <del>${{item.origin_price}}</del>
                    <span class="text-danger h5 ms-auto">${{item.price}}</span>
                  </template>
                </div>
                <div class="d-flex justify-content-center">
                  <button
                    @click="getProductDetail(item.id)"
                    class="btn btn-outline-primary me-3"
                    type="button"
                  >
                    <span
                      v-if="loadingStatus.itemLoading === item.id"
                      class="spinner-grow spinner-grow-sm"
                      role="status"
                      aria-hidden="true"
                    >
                    </span>
                    <!-- Loading... -->

                    看詳細
                  </button>
                  <button
                    @click="addCart(item.id)"
                    class="btn btn-danger"
                    type="button"
                  >
                    <span
                      v-if="loadingStatus.itemLoading === item.id"
                      class="spinner-grow spinner-grow-sm"
                      role="status"
                      aria-hidden="true"
                    ></span>

                    加入購物車
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        <template v-if="pagination">
          <pagination
            :pagination="pagination"
            @get-products="getProducts"
          ></pagination>
        </template>
        <!-- 購物車區塊 -->
        <div class="row">
          <div class="text-end">
            <button class="btn btn-sm btn-outline-danger">清空購物車</button>
          </div>
          <table class="table">
            <thead>
              <tr>
                <th scope="col">商品選項{{Object.keys(carts).length}}</th>
                <th scope="col">單價</th>
                <th scope="col">數量</th>
                <th scope="col">小計</th>
                <th scope="col">刪除</th>
              </tr>
            </thead>
            <tbody>
              <tr v-for="cart in carts.carts" :key="cart.id">
                <th>
                  <div class="cart__title d-flex">
                    <div class="me-3">
                      <img :src="cart.product.imageUrl" :alt="cart.product.title" width="50" class="img-fluid">
        
                    </div>
                    <div class="cart__title__content">
                      <div class="h6">{{cart.product.title}}</div>
                      <p>規格</p>
                    </div>
                  </div>
                </th>
                <td class="text-end">NT ${{cart.product.price}}</td>
                <td>
                  <div class="btn-group" role="group" aria-label="Basic checkbox toggle button group">
                    <button type="button" class="btn btn-primary">+</button>
                    <input v-model="cart.qty" type="number" min=1 class="form-control rounded-0" style="width:80px">
        
                    <button type="button" class="btn btn-primary">-</button>
        
                  </div>
                </td>
                <td class="text-end">NT ${{cart.final_total}}</td>
                <td>
                  <button @click="deleteCart(cart.id)" class="btn btn-sm btn-outline-danger">刪除</button>
                </td>
              </tr>
            </tbody>
            <tfoot>
              <tr>
                <td class="text-end" colspan="100">
                  原價 NT $ {{carts.total}}
                </td>
              </tr>
              <tr>
                <td class="text-end" colspan="100">
                  總價 NT $ {{carts.final_total}}
                </td>
              </tr>
            </tfoot>
          </table>
        </div>
        <!-- 驗證表單 -->
        <div class="row">
          <table class="table">
            <thead>
              <tr>
                <th scope="col">#</th>
                <th scope="col">First</th>
                <th scope="col">Last</th>
                <th scope="col">Handle</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <th scope="row">1</th>
                <td>Mark</td>
                <td>Otto</td>
                <td>@mdo</td>
              </tr>
              <tr>
                <th scope="row">2</th>
                <td>Jacob</td>
                <td>Thornton</td>
                <td>@fat</td>
              </tr>
              <tr>
                <th scope="row">3</th>
                <td colspan="2">Larry the Bird</td>
                <td>@twitter</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- productDetailModal -->
      <product-detail-modal @add-cart="addCart" :product = "tempProductDetail" @clear-temp-product-detail="clearTempProductDetail" ref="productDetail"></product-detail-modal>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-gtEjrD/SeCtmISkJkNUaaKMoLD0//ElJ19smozuHV6z3Iehds+3Ulb9Bn9Plx0x4"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.9.1/axios.min.js"
      integrity="sha512-Xk3wWei2TGrsh9kDSBKUMIjw/86sLUvhtnv9f7fOuIwhhiUTKz8szkWkzHthrM5Bb3Bu9idSzkxOrkzhcneuiw=="
      crossorigin="anonymous"
    ></script>
    <!-- 分頁  template -->
    <script type="x-template" id="pagination">
      <nav>
        <ul class="pagination justify-content-center">
          <li @click="getProducts(watchPagination.currentPage-1)" class="page-item " :class="{disabled: !watchPagination.has_pre}">
            <a class="page-link" href="#" tabindex="-1" aria-disabled="true">Previous</a>
          </li>
          <li @click="getProducts(page)" v-for="page in watchPagination.total_pages" :class="{active: page === watchPagination.current_page}" :key="page" class="page-item">
            <a class="page-link" href="#">{{page}}</a>
          </li>
          <li @click="getProducts(watchPagination.current_page+1)" class="page-item"  :class="{disabled: !watchPagination.has_next}">
            <a class="page-link" href="#">Next</a>
          </li>
        </ul>
      </nav>
    </script>
    <!-- 產品詳細 -->
    <script type="x-template" id="productDetailTemplate">
      <div ref="modal" class="modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">{{watchProduct.title}}產品詳細</h5>
              <button @click="closeModal" type="button" class="btn-close" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div class="container">
                <div class="row mb-3">
                  <div class="col-md-6">
                    <div class="slide__main p-3">
                      <div class="bg-cover img-fluid" :style = "`background-image: url(${watchProduct.imageUrl})`" style="min-height: 350px ;" alt="watchProduct.title"></div>
              
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="d-flex flex-column justify-content-between h-100">
                      <h1 class="p-3">#{{watchProduct.title}} </h1>
                      <!-- <div class="d-flex mb-3">
                        <div class="me-3">口味:</div>
                        <div class="me-3"><button class="btn btn-sm btn-primary">青</button></div>
                        <div class="me-3"><button class="btn btn-sm btn-primary">青</button></div>
                        <div class="me-3"><button class="btn btn-sm btn-primary">青</button></div>
                        <div class="me-3"><button class="btn btn-sm btn-primary">青</button></div>
                        <div><button class="btn btn-sm btn-primary">青</button></div>
                      </div> -->
                      <div class="d-flex mb-3 align-items-center">
                        <div class="me-2">數量:</div>
                        <div class="btn-group me-3" role="group" aria-label="Basic checkbox toggle button group">
                          <button @click="numCountHandler('pluse')" type="button" class="btn btn-primary">+</button>
                          <input v-model.number="numRangeLimit" type="number" min=1 class="form-control rounded-0" style="width:80px">
                          <button  @click="numCountHandler('minus')" type="button" class="btn btn-primary">-</button>
              
                        </div>
                        {{watchProduct.unit}}
                      </div>
                      <div class="d-flex justify-content-cnter">
                        <!-- <div class="btn btn-lg btn-primary me-3">+ 立即結帳</div> -->
                        <div @click="addCart" class="btn btn-lg btn-primary">+ 加入購物車</div>
                      </div>
                    </div>
              
                  </div>
                </div>
                <div class="row">
                  <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active" id="pills-home-tab" data-bs-toggle="pill" data-bs-target="#pills-home" type="button" role="tab" aria-controls="pills-home" aria-selected="true">簡介</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pills-profile-tab" data-bs-toggle="pill" data-bs-target="#pills-profile" type="button" role="tab" aria-controls="pills-profile" aria-selected="false">詳細</button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pills-contact-tab" data-bs-toggle="pill" data-bs-target="#pills-contact" type="button" role="tab" aria-controls="pills-contact" aria-selected="false">購買流程</button>
                    </li>
                  </ul>
                  <div class="tab-content" id="pills-tabContent">
                    <div class="tab-pane fade show active" id="pills-home" role="tabpanel" aria-labelledby="pills-home-tab">
                      {{watchProduct.description}}
                    </div>
                    <div class="tab-pane fade" id="pills-profile" role="tabpanel" aria-labelledby="pills-profile-tab">
                      {{watchProduct.content}}
                    </div>
                    <div class="tab-pane fade" id="pills-contact" role="tabpanel" aria-labelledby="pills-contact-tab">
                      購買流程 ... 
                    </div>
                  </div>
              
                </div>
              
              </div>
            </div>

            <!-- <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary">Save changes</button>
            </div> -->
          </div>
        </div>
      </div>
    </script>
    <script type="module">
      import { createApp } from "https://cdnjs.cloudflare.com/ajax/libs/vue/3.0.9/vue.esm-browser.js";
      const apiUrl = "https://vue3-course-api.hexschool.io";
      const apiPath = "pet";

      createApp({
        data() {
          return {
            loadingStatus: {
              itemLoading: null,
            },
            products: null,
            pagination: null,
            tempProductDetail: {},
            carts: {}
          };
        },
        methods: {
          // 購物車區
          getCart() {
            axios
              .get(`${apiUrl}/api/${apiPath}/cart`)
              .then((res) => {
                if (res.data.success) {
                  const { data } = res.data;
                  this.carts = data;
                } else {
                  alert(res.data.message);
                }
              })
              .catch((error) => {
                console.log(error);
              });
          },
          // 刪除單一購物車
          deleteCart(id) {
            axios
              .delete(`${apiUrl}/api/${apiPath}/cart/${id}`)
              .then((res) => {
                if (res.data.success) {
                  alert(res.data.message)
                  this.getCart();
                } else {
                  alert(res.data.message);
                }
              })
              .catch((error) => {
                console.log(error);
              });
          },
          // 產品列表

          clearTempProductDetail(){
            this.tempProductDetail = {}
          },
          getProductDetail(id){
            this.loadingStatus.itemLoading = id;
            axios
              .get(`${apiUrl}/api/${apiPath}/product/${id}`)
              .then((res) => {
                this.loadingStatus.itemLoading = null;
                if (res.data.success) {
                  this.tempProductDetail = res.data.product;
                  this.openProductDetailModal()
                } else {
                  alert(res.data.message);
                }
              })
              .catch((error) => {
                console.log(error);
              });
          },
          openProductDetailModal() {
            this.$refs.productDetail.openModal();
          },
          addCart(product_id, qty = 1) {
            const data = { data: { product_id, qty } };
            this.loadingStatus.itemLoading = product_id;
            axios
              .post(`${apiUrl}/api/${apiPath}/cart`, data)
              .then((res) => {
                this.loadingStatus.itemLoading = null;
                if (res.data.success) {
                  alert(res.data.message);
                } else {
                  alert(res.data.message);
                }
              })
              .catch((error) => {
                console.log(error);
              });
          },
          getProducts(page = 1) {
            axios
              .get(`${apiUrl}/api/${apiPath}/products?page=${page}`)
              .then((res) => {
                if (res.data.success) {
                  const { products, pagination } = res.data;
                  this.products = products;
                  this.pagination = pagination;
                } else {
                  alert(res.data.message);
                }
              })
              .catch((error) => {
                console.log(error);
              });
          },
        },
        mounted() {
          this.getProducts();
          this.getCart();
        },
      })
        .component("card", {
          template: `<button class="btn btn-primary">{{name}}</button>`,
          data() {
            return {
              name: "Eric",
            };
          },
        })
        .component("productDetailModal", {
          template: '#productDetailTemplate',
          props:{
            product:{
              type: Object,

            }
          },
          data() {
            return {
              modal: "",
              num: 1,
              watchProduct:{}
            };
          },
          computed:{
            // 產品 num 基數 不是 1 怪怪的 再修正
            numRangeLimit:{
              get(){
                return this.watchProduct.num
              },
              set(val){
                this.watchProduct.num =  val < 1 ? 1 : val >=999 ? 999 : val
              }
            }
          },
          methods: {
            addCart(){
              this.$emit('add-cart',  this.watchProduct.id, this.watchProduct.num)
            },
            numCountHandler(type){
              this.numRangeLimit = type === 'pluse' ? ++this.numRangeLimit : --this.numRangeLimit 
            },
            openModal() {
              this.modal.show();
            },
            closeModal() {
              this.modal.hide();
              this.$emit('clearTempProductDetail')
            },
          },
          watch:{
            product(){
              this.watchProduct = this.product
            }
          },
          mounted() {
            this.modal = new bootstrap.Modal(this.$refs.modal);
          },
        })
        .component("pagination", {
          template: "#pagination",
          props: {
            pagination: {
              type: Object,
            },
            // currentPage:{
            //   type: Number,
            // },
            // hasNext:{
            //   type: Boolean,
            // },
            // hasPre:{
            //   type: Boolean,
            // },
            // totalPages:{
            //   type: Number,
            // },
          },
          data() {
            return {
              watchPagination: {
                category: null,
                current_page: null,
                has_next: false,
                has_pre: false,
                total_pages: null,
              },
            };
          },
          watch: {
            pagination: {
              handler() {
                this.watchPagination = { ...this.pagination };
              },
              immediate: true,
            },
          },
          methods: {
            getProducts(page) {
              this.$emit("get-products", page);
            },
          },
        })
        .mount("#app");
    </script>
  </body>
</html>
